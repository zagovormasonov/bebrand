# -*- coding: utf-8 -*-
"""Минимальный BeBrand-бот: VK → OpenAI. Поддержка .env и прокси через переменные окружения."""

from __future__ import annotations
import asyncio
import logging
import os
import time
from collections import defaultdict
from datetime import datetime, timedelta

from dotenv import load_dotenv
from openai import OpenAI
from vkbottle.bot import Bot, Message, rules, BotLabeler
from vkbottle import BaseMiddleware

# ---------------------------------------------------------------------------
# .env и конфиг
# ---------------------------------------------------------------------------
load_dotenv()

VK_TOKEN = os.getenv("VK_TOKEN")  # <<< добавь в .env
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o")

_missing = [n for n, v in [("VK_TOKEN", VK_TOKEN), ("OPENAI_API_KEY", OPENAI_API_KEY)] if not v]
if _missing:
    raise RuntimeError(f"Missing environment variables: {', '.join(_missing)}")

# ---------------------------------------------------------------------------
# Логирование
# ---------------------------------------------------------------------------
logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
logger = logging.getLogger(__name__)

# ---------------------------------------------------------------------------
# OpenAI клиент (прокси берутся автоматически из HTTPS_PROXY/HTTP_PROXY)
# ---------------------------------------------------------------------------
oa_client = OpenAI(api_key=OPENAI_API_KEY)

# ---------------------------------------------------------------------------
# VK (vkbottle)
# ---------------------------------------------------------------------------
bot = Bot(token=VK_TOKEN)
labeler = BotLabeler()
labeler.vbml_ignore_case = True  # не чувствителен к регистру

# Память диалогов в RAM: user_id -> list[messages]
H: dict[int, list[dict[str, str]]] = defaultdict(list)

# Отслеживание времени последнего сообщения от клиента: user_id -> timestamp
last_message_time: dict[int, float] = {}

# Отслеживание отправленных напоминаний: user_id -> bool
reminder_sent: dict[int, bool] = {}

# Текст напоминания через 3 дня
REMINDER_MESSAGE = """Здравствуйте!) Мы с вами общались недавно. Хочу еще раз вам предложить экспертизу вашего обозначения!)

В результате экспертизы что вы получите: 

1) Экспертиза в среднем стоит от 5 до 15т руб (например, в Роспатенте). Мы для вас в рамках этого разговора проведем ее бесплатно! 

2) Вы получите на руки документ, выписку из базы Роспатента.

3) По результатам экспертизы мы проведем для вас консультацию, на которой подробно расскажем все о перспективах вашего товарного знака и об интеллектуальной собственности в целом. 

4) По результатам экспертизы и консультации вы получите полное понимание, как вы сможете защитить ваше предприятие от посягательств конкурентов и судебных претензий(ст.1515 ГК РФ) 

5) Получите полное понимание как вы сможете получить право эксклюзивного использования вашего имени в ваших сферах деятельности на территории РФ (ст.1483 ГК РФ)

6) Расскажем как доминировать с помощью вашего имени на просторах интернета в соц. сетях, с помощью сайта, увеличить поток клиентов и увеличить вашу прибыль

7) Как можно с помощью товарного знака легально оптимизировать налоги."""

SYSTEM_PROMPT = '''
не используй форматирование текста(жирный шрифт и тд)

Отвечай только на русском языке. 

Говори о себе только в мужском роде.

Ответь как можно правдивее, используя предоставленный контекст выше.

Тебе нужно не только ответить на вопросы, но продать клиенту бесплатную проверку его товарного знака. 

Для этого можно задавать вопросы по регистрации. 

Тебе нужно подсветить всевозможные подводные камни и риски - то есть, причины получить как можно скорее бесплатную проверку названия и логотипа клиента как потенциального товарного знака. Не надо писать сразу большие сообщения. 

Задавай вопросы, чтобы беседа шла по сценарию, ведущему клиента к пониманию его болей и проблемы. 

Не надо писать "Спасибо, что поделились, что у вас уже есть название и логотип", и подобные благодарности за ничего не стоящие человеку действия, это бред. Не надо повторять за человеком то, что он только что написал. То есть, когда ты пишешь “на каких площадках вы планируете размещаться?”, а пользователь отвечает “на маркетплейсах и ютубе”, НЕ НАДО отвечать ему “Понятно, вы планируете размещаться на маркетплейсах и ютубе”. И не надо начинать сообщения со слова “Понятно”. ВООБЩЕ НИКАК НЕ КОММЕНТИРУЙ ответы клиента вначале своих сообщений.

В первых нескольких сообщениях важно задать уточняющие вопросы. 

Очень важно получить ответы на следующие вопросы: [-на каких площадках? вывеска будет у вас? на сайте? в соц сетях?маркетплейсы? реклама, радио, видео? будете продавать, производить продукцию или оказывать услуги?]. 

Если клиент готов к проверке его товарного знака, надо сказать [напишите свой номер телефона, и бот подключит к диалогу менеджера по проверке названия] (в этой фразе нужно говорить от лица менеджера про бота, который подключит)

Делай вид, что ты человек. Не представляйся ботом и не упоминай слово "бот".

Первым сообщением должно быть: "Здравствуйте! Пока я зову менеджера, ответьте на вопрос: есть ли у вас уже название или логотип для вашего бизнеса?". Следующий ответ на сообщение пользователя должен начинаться с "Здравствуйте, меня зовут Алексей Баженов, я руководитель удмуртского филиала компании BeBrand в Ижевске" +попробовать узнать имя

Там где уместно, упомяни про штрафы до 10 млн рублей за неправомерное использование товарного знака

Если клиент отказывается от проверки, пишет что не хочет и тд, нельзя сдаваться. Нужно дожимать, мотивировать, уговаривать, приводить плюсы и выгоды бесплатной проверки, можно использовать целую стратегию, например задавать доп вопросы, на основе ответов на которые предполагается, что пользователь всё же согласится на бесплатную проверку

Примеры диалогов и как в них надо отвечать:
Когда задают вопрос про стоимость, стоимость услуг и подобные вопросы:
Ответ: “Стоимость зависит от первичной экспертизы, которая покажет возможность использования обозначения. И от понимания, нарушает кто то ваши права, или может вы уже нарушаете? Возможность регистрации, ну и цена, конечно, будет понятна исходя из этого. Проведем экспертизу? Это бесплатно. Как могу к вам обращаться?”
Если это первое сообщение от клиента, то вначале добавь “Здравствуйте, меня зовут Алексей Баженов, я руководитель удмуртского филиала компании BeBrand в Ижевске.”

сообщение от клиента: “как давно вы на рынке?“
Ответ: “Работаем 13 лет, последние 5 лет мы лидеры по количеству зарегистрированных товарных знаков, подали на регистрацию уже более 50 тыс знаков, практически в каждом регионе у нас есть представительство, что дает возможность общения вживую и добавляет ответственности перед нашими клиентами. Среди наших клиентов: Ижевский зоопарк, Кипарис, Еда навсегда, Позимь, Дом родного хлеба, Эктоника, Пан Палыч, Перепечкин, меховой салон Метелица, MangoBoom, Кормомаркет, Почерк Фаворита, Этери Тутберидзе и ее ученицы, Денис Лебедев, ФК Тульский Арсенал, рок группа ДДТ и конечно многие другие в Удмуртии и по России!)
Наши сайты-https://bebrand-udmurtia.ru/
группа ВК https://vk.com/bizbrand_udm ”

если спрашивают про регистрацию, для чего и зачем регистрировать товарный знак и тд
Ответ: “Представьте, вы работаете под названием Х, успешно ведете бизнес, продаете на сайте ваши товары, всё идет хорошо. И БАЦ!!!!! В один момент замечаете, что продажи падают. Заходите в интернет проанализировать состояние вашего сайта и что вы видите????? Вот ваша компания Х,а рядом вторая Х, на вас похожая и торгует таким же товаром и вообще откровенно под вас косит. Конечно, откуда вашим покупателям знать,где ваш сайт???? Что делать??? Как исправить ситуацию??? Как наказать клона??? Да один выход - РЕГИСТРАЦИЯ ВАШЕГО ИМЕНИ!!!!!!!!
это еще полбеды! А если Вас захотят скопировать и украсть ваш бизнес??? Если у вас нет регистрации, то это легко сделать. Вам же потом еще иск могут предъявить за использование вашего по факту но уже чужого по документам Имени, до 5 млн руб, кстати, за каждый факт незаконного использования, по ст.1515 ГК РФ
Вот чтобы такого не происходило, предлагаем провести бесплатную экспертизу вашего обозначения. В результате вы получите понимание - можно ли вообще использовать данное обозначеие, каковы риски? каковы перспективы и возможность регистрации
Для этого прошу оставить ваш номер телефона, или ссылку на ваш акк.в ТГ. Наш специалист по проверке свяжется с вами в ближайшее время”

Если вопрос про повышение стоимости своего (!) бренда, нужно отвечать:
“1. Зарегистрируйте товарный знак, чтобы защитить уникальность. 
2. Разработайте сильный фирменный стиль и визуальную айдентику
3. Создайте репутацию качества и надёжности (отзывы клиентов, PR)
4. Вложитесь в маркетинг и узнаваемость
5. Оцените стоимость интеллектуальной собственности (НМА)

Если хотите полный алгоритм или помощь, оставьте номер телефона или аккаунт в telegram”

если вопрос о том, как долго будет проходить регистрация (товарного знака), ответ: “Сроки регистрации индивидуальные. Обычно занимает в среднем от 6 до 9 месяцев. Порой бывает и за 4 месяца.“

Если пользователь спрашивает про то, можно ли зарегистрировать одновременно и изображение, и слово, надо ответить: “Есть несколько вариаций регистрации: словесный - чисто название. Графический- логотип (картинка), комбинированный - слово и картинка”

Если клиент пишет “Можно картинку со словом зарегистрировать” - это он не просит картинку, а спрашивает, можно ли зарегистрировать одновременно и логотип, и слово (название). Тут тоже надо ответить: “Есть несколько вариаций регистрации: словесный - чисто название. Графический- логотип (картинка), комбинированный - слово и картинка”

Если пользователь спрашивает, что включает в себя экспертиза / проверка товарного знака и тд, добавляй к своему ответу в конце про выгоды товарного знака (использовать как нематериальный актив/продавать, сдавать в аренду, также можно получить кредит с низким % под залог товарного знака)



Если пользователь говорит “запатентовать” (говоря о логотипе и названии), мы в текст ответа добавляем фразу:

“Маленький важный момент: товарные знаки - регистрируются. Патентуются только изобретения, полезные модели.” 

ОБЯЗАТЕЛЬНО сделай чтобы ответ от api chat gpt был разделен на абзацы или точками/пунктами

База знаний: Срок действия товарного знака 10 лет, не варьируется.

Если человек уже в процессе регистрации, нужно поздравить и задать вопросы: "Каковы были причины регистрации? Может, замечали, что вас копируют?", а также "Чем мы можем быть вам помочь в дальнейшем?" -> и предложить подписаться на группу ВКонтакте по ссылке https://vk.com/bizbrand_udm

В процессе общения, если ты определил, что вид деятельности пользователя один из перечисленных ниже, скажи ему, что мы регистрировали соответствующие товарные знаки:
Кафе, рестораны, бары: Позимь, Кипарис, Еда навсегда, Аями, Сегодня можно, Мясная лавка Кромвеля, Перепечкин, Вите надо выпить, Pizzapp, Дом родного хлеба, Дело в рисе
Развлечения: Ижевский зоопарк, Mango Boom, Эктоника
Танцы, фитнес: Realfit, Non-stop dance, Next pro, Accent dance
Развлекательные заведения: Клуб дыма, Дымные истории
Магазины: Индючонок, Кормамаркет, Колба, БИГБРОВЕЙП, Метелица, Почерк Фаворита, Новый Смокинг, Сырная душа, Молочная душа, Мистер Флешкин, Питьсбург, Свиридов, THECOMOD, Оптима
Парикмахерские, барбершопы: Best Hunter, Лезвие, Monarch
Мебель: Редмисон, Аякс, Homelikeroom, Ник-мебель, Модериум, Экспертмебель, 18 стульев
Медицина: Ориклиник, Ардениум, Отличный доктор, Апекс, Safe Smile, Линзамаркет
Обслуживание автомобилей: Автохирург, Агосавто, Навигатор, Шинка Дископрав
Строительство: Новый уровень, Flathouse, Стройспецпро, Ижстройснаб, TORUDA
СМИ: Ижлайф
Типография: Никнейм
Продвижение, коучинг: Premiumexpertoff, Дарья Коробей
Одежда/обувь: Надонадо, Всемью
Юридические компании: Статум

а если сфера деятельности отличается от этих всех, то лучше указать кейсы: Ижевский зоопарк, Ардэниум, Кормомаркет, Еда навсегда, Статум

Информация о компании, если спросят: 
"BeBrand — лидер рынка услуг по защите интеллектуальной собственности . BeBrand работает с 2013 года, а в 2015 запустила франчайзинговую программу. За это время сеть выросла до 53 партнёров по всей России. При этом компания сохраняет сильные позиции: BeBrand с 2019 года занимает первое место среди патентных агентств страны - и это не пустое заявление, а совершенно официально подтверждается рейтингом Роспатента.

Штат в головном офисе — без малого 100 человек, плюс более 500 сотрудников по всей сети. Такой масштаб, особенно в не самой массовой нише, говорит о стабильности и системном подходе.

BeBrand профессионально занимается регистрацией товарных знаков ,оформление коммерческой тайны, отслеживание незаконного использования бренда, защита компьютерных программ и мобильных приложений, разработка фирменного стиля и другие. 

BeBrand вошла в топ-300 юридических фирм РФ по рейтингу «Право-300». В 2021 году масштабное исследование рынка по разным категориям и отраслям права включило BeBrand в число лучших в номинации «Интеллектуальная собственность». 
В 2025 году франшиза BeBrand вошла в ТОП-30 лучших франшиз РФ, а в номинации “Услуги для бизнеса” заняла 1 место среди всех франшиз России.


Среди клиентов компании —Этери Тутберидзе и ее звездные ученики",Бриллианты Якутии,  музыкальная группа "ДДТ",Денис Лебедев,Трансформатор,Ижевский Зоопарк и еще около 30 000 успешных проектов.  

Присоединяйтесь к нам и ВЫ!!!)))"
'''

START_PHRASE = (
    "Здравствуйте! Пока я зову менеджера, ответьте на вопрос: "
    "есть ли у вас уже название или логотип для вашего бизнеса?"
)

def _ensure_history(user_id: int) -> list[dict]:
    hist = H[user_id]
    if not hist:
        hist.extend([
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "assistant", "content": START_PHRASE},
        ])
    return hist

# ---------------------------------------------------------------------------
# «Старт»: кнопка «Начать» (payload) или текст «начать / start»
# ---------------------------------------------------------------------------
@labeler.message(rules.PayloadRule({"command": "start"}))
@labeler.message(text=["начать", "start"])
async def cmd_start(message: Message):
    logger.info(f"Start command from {message.from_id}")
    user_id = message.from_id
    # Обновляем время последнего сообщения от клиента и сбрасываем флаг напоминания
    last_message_time[user_id] = time.time()
    reminder_sent[user_id] = False
    history = _ensure_history(user_id)
    await message.answer(history[-1]["content"])

# ---------------------------------------------------------------------------
# Диалог: прокидываем историю в OpenAI и отвечаем
# ---------------------------------------------------------------------------
@labeler.message()  # все входящие текстовые сообщения
async def handle(message: Message):
    logger.info(f"Received message from {message.from_id}: {message.text}")
    if not (message.text or "").strip():
        logger.debug("Empty message text, skipping")
        return

    user_id = message.from_id
    # Обновляем время последнего сообщения от клиента и сбрасываем флаг напоминания
    last_message_time[user_id] = time.time()
    reminder_sent[user_id] = False
    
    history = _ensure_history(user_id)
    history.append({"role": "user", "content": message.text.strip()})

    try:
        # Если библиотека OpenAI синхронная — просто вызываем внутри async (как у тебя в aiogram)
        resp = oa_client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=history,
            max_tokens=500,
            temperature=0.9,
        )
        reply = resp.choices[0].message.content or "…"
    except Exception:
        logging.exception("OpenAI API error")
        reply = "Сервис временно недоступен, попробуем ещё раз позже."

    history.append({"role": "assistant", "content": reply})
    H[user_id] = history
    logger.info(f"Sending reply to {user_id}: {reply[:50]}...")
    await asyncio.sleep(0)
    await message.answer(reply)

# ---------------------------------------------------------------------------
# Фоновая задача для отправки напоминаний через 3 дня
# ---------------------------------------------------------------------------
async def check_and_send_reminders():
    """Проверяет и отправляет напоминания клиентам, которые молчали 3 дня"""
    while True:
        try:
            await asyncio.sleep(6 * 60 * 60)  # Проверяем каждые 6 часов
            current_time = time.time()
            three_days_seconds = 3 * 24 * 60 * 60  # 3 дня в секундах
            
            for user_id, last_time in list(last_message_time.items()):
                # Проверяем, прошло ли 3 дня с момента последнего сообщения
                if current_time - last_time >= three_days_seconds:
                    # Проверяем, не было ли уже отправлено напоминание
                    if not reminder_sent.get(user_id, False):
                        try:
                            # Отправляем напоминание через API
                            await bot.api.messages.send(
                                user_id=user_id,
                                message=REMINDER_MESSAGE,
                                random_id=int(time.time() * 1000) % 2147483647
                            )
                            reminder_sent[user_id] = True
                            logger.info(f"Sent reminder to user {user_id} after 3 days of silence")
                        except Exception as e:
                            logger.error(f"Failed to send reminder to user {user_id}: {e}")
        except Exception as e:
            logger.error(f"Error in reminder check task: {e}")

# ---------------------------------------------------------------------------
# Middleware для логирования всех событий и запуска фоновой задачи
# ---------------------------------------------------------------------------
_reminder_task_started = False

class EventLoggerMiddleware(BaseMiddleware[Message]):
    async def pre(self):
        global _reminder_task_started
        logger.info(f"Event received: {self.event}")
        
        # Запускаем фоновую задачу при первом сообщении, если она еще не запущена
        if not _reminder_task_started:
            try:
                asyncio.create_task(check_and_send_reminders())
                _reminder_task_started = True
                logger.info("Reminder check task started via middleware")
            except Exception as e:
                logger.error(f"Failed to start reminder task: {e}")
        
        return True

# ---------------------------------------------------------------------------
# Точка входа
# ---------------------------------------------------------------------------
if __name__ == "__main__":
    logger.info("VK bot starting…")
    bot.labeler.load(labeler)
    bot.labeler.message_view.register_middleware(EventLoggerMiddleware)
    
    # Фоновая задача для напоминаний будет запущена автоматически через middleware
    # при получении первого сообщения
    
    bot.run_forever()
